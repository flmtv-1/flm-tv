// flm-viewer/auth/login.js
// This file handles all Firebase Authentication and Parental Control logic.
// It is included in index.html to manage user sessions and permissions.

import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    signOut,
    signInWithCustomToken,
    signInAnonymously
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Global Firebase Instances ---
let auth;
let db;
let isAuthInitialized = false;

// --- Global UI Elements & State ---
let isUserSignedIn = false;
let currentUserId = null;
let parentCode = null;
let securityQuestion = null;
let securityAnswer = null;
let isParentalControlEnabled = false;

// UI Elements for Auth Modal
const AUTH_MODAL = document.getElementById('authModal');
const AUTH_EMAIL_INPUT = document.getElementById('authEmail');
const AUTH_PASSWORD_INPUT = document.getElementById('authPassword');
const SIGN_IN_BTN = document.getElementById('signInBtn');
const SIGN_OUT_BTN = document.getElementById('signOutBtn');
const TEMP_AUTH_MESSAGE = document.getElementById('tempAuthMessage');
const TOGGLE_AUTH_PASSWORD_VISIBILITY = document.getElementById('toggleAuthPasswordVisibility');

// UI Elements for Parental Control Modal
const PARENTAL_CONTROL_MODAL = document.getElementById('parentalControlModal');
const PARENT_CODE_INPUT = document.getElementById('parentCodeInput');
const PARENT_CODE_CONFIRM_INPUT = document.getElementById('parentCodeConfirmInput');
const SECURITY_QUESTION_INPUT = document.getElementById('securityQuestionInput');
const SECURITY_ANSWER_INPUT = document.getElementById('securityAnswerInput');
const SECURITY_PROMPT_MODAL = document.getElementById('securityPromptModal');
const SECURITY_ANSWER_PROMPT_INPUT = document.getElementById('securityAnswerPromptInput');

// --- Helper Functions ---

/**
 * Custom alert function to replace window.alert
 * @param {string} message - The message to display.
 */
function showCustomAlert(message) {
    const modal = document.getElementById('customAlertModal');
    const msgElement = document.getElementById('customAlertMessage');
    msgElement.textContent = message;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function hideCustomAlert() {
    const modal = document.getElementById('customAlertModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

/**
 * Displays a temporary message in the auth modal.
 * @param {string} message - The message to display.
 * @param {string} type - 'info', 'warning', or 'error'.
 */
function showTempAuthMessage(message, type = 'info') {
    TEMP_AUTH_MESSAGE.textContent = message;
    TEMP_AUTH_MESSAGE.style.display = 'block';
    TEMP_AUTH_MESSAGE.style.borderColor = type === 'error' ? 'red' : (type === 'warning' ? 'orange' : 'var(--primary)');
    TEMP_AUTH_MESSAGE.style.color = type === 'error' ? 'red' : (type === 'warning' ? 'orange' : 'var(--primary)');

    setTimeout(() => {
        TEMP_AUTH_MESSAGE.style.display = 'none';
    }, 5000);
}

/**
 * Toggles the visibility of the authentication modal.
 */
function toggleAuthModal() {
    if (AUTH_MODAL) {
        AUTH_MODAL.classList.toggle('hidden');
        AUTH_MODAL.classList.toggle('flex');
    }
}

/**
 * Toggles the visibility of the parental controls modal.
 */
function openParentalControlsModal() {
    if (PARENTAL_CONTROL_MODAL) {
        PARENTAL_CONTROL_MODAL.classList.remove('hidden');
        PARENTAL_CONTROL_MODAL.classList.add('flex');
    }
}

function closeParentalControlsModal() {
    if (PARENTAL_CONTROL_MODAL) {
        PARENTAL_CONTROL_MODAL.classList.remove('flex');
        PARENTAL_CONTROL_MODAL.classList.add('hidden');
    }
}

/**
 * Toggles the visibility of the security question prompt modal.
 */
function promptForSecurityAnswer(callback) {
    const submitBtn = document.getElementById('verifySecurityAnswerBtn');
    submitBtn.onclick = () => {
        const answer = SECURITY_ANSWER_PROMPT_INPUT.value;
        if (answer.toLowerCase() === securityAnswer.toLowerCase()) {
            SECURITY_PROMPT_MODAL.classList.add('hidden');
            callback(true);
        } else {
            showCustomAlert("Incorrect security answer. Try again.");
            callback(false);
        }
    };
    document.getElementById('securityPromptQuestion').textContent = securityQuestion;
    SECURITY_PROMPT_MODAL.classList.remove('hidden');
    SECURITY_PROMPT_MODAL.classList.add('flex');
}

function closeSecurityPromptModal() {
    SECURITY_PROMPT_MODAL.classList.add('hidden');
    SECURITY_PROMPT_MODAL.classList.remove('flex');
}


// --- Firebase Auth Functions ---

/**
 * Handles the sign-in process.
 */
async function signIn() {
    const email = AUTH_EMAIL_INPUT.value;
    const password = AUTH_PASSWORD_INPUT.value;
    try {
        await signInWithEmailAndPassword(auth, email, password);
        showTempAuthMessage("Signed in successfully!", "info");
        toggleAuthModal();
    } catch (error) {
        console.error("Sign-in failed:", error.message);
        showTempAuthMessage(`Sign-in failed: ${error.message}`, "error");
    }
}

/**
 * Handles the sign-out process.
 */
async function signOutUser() {
    try {
        await signOut(auth);
        showCustomAlert("Signed out successfully.");
    } catch (error) {
        console.error("Sign-out failed:", error.message);
        showCustomAlert(`Sign-out failed: ${error.message}`);
    }
}

// --- Parental Controls Functions ---

/**
 * Loads parental control settings from Firestore for the current user.
 */
async function loadParentalSettings() {
    if (!currentUserId || !db) return;

    try {
        const settingsDocRef = doc(db, `artifacts/${window.appId}/users/${currentUserId}/parentalSettings/settings`);
        const docSnap = await getDoc(settingsDocRef);
        if (docSnap.exists()) {
            const settings = docSnap.data();
            isParentalControlEnabled = settings.isEnabled;
            parentCode = settings.parentCode;
            securityQuestion = settings.securityQuestion;
            securityAnswer = settings.securityAnswer;
            console.log("Parental settings loaded:", settings);
        } else {
            console.log("No parental settings found for this user.");
            isParentalControlEnabled = false;
        }
    } catch (error) {
        console.error("Error loading parental settings:", error);
    }
}

/**
 * Sets new parental control settings in Firestore.
 */
async function setParentCode() {
    const code = PARENT_CODE_INPUT.value;
    const confirmCode = PARENT_CODE_CONFIRM_INPUT.value;
    const question = SECURITY_QUESTION_INPUT.value;
    const answer = SECURITY_ANSWER_INPUT.value;

    if (!code || !confirmCode || !question || !answer) {
        showCustomAlert("All fields are required.");
        return;
    }

    if (code !== confirmCode) {
        showCustomAlert("The codes do not match.");
        return;
    }

    if (!currentUserId || !db) {
        showCustomAlert("You must be signed in to set parental controls.");
        return;
    }

    try {
        const settingsDocRef = doc(db, `artifacts/${window.appId}/users/${currentUserId}/parentalSettings/settings`);
        await setDoc(settingsDocRef, {
            isEnabled: true,
            parentCode: code,
            securityQuestion: question,
            securityAnswer: answer
        });
        showCustomAlert("Parental controls set successfully!");
        parentCode = code;
        securityQuestion = question;
        securityAnswer = answer;
        isParentalControlEnabled = true;
        closeParentalControlsModal();
    } catch (error) {
        console.error("Error setting parental code:", error);
        showCustomAlert("Failed to set parental code. Please try again.");
    }
}

/**
 * Checks if the provided code matches the parental code.
 * @param {string} code - The code to check.
 * @returns {boolean}
 */
function checkParentCode(code) {
    return isParentalControlEnabled && code === parentCode;
}


// --- Auth State Listener ---

onAuthStateChanged(auth, async (user) => {
    isAuthInitialized = true; // Flag that auth is ready
    if (user) {
        isUserSignedIn = true;
        currentUserId = user.uid;
        document.getElementById('userIdDisplay').textContent = `User: ${currentUserId.substring(0, 8)}...`;
        document.getElementById('userIdDisplay').classList.remove('hidden');
        console.log("User is signed in:", user.uid);
        await loadParentalSettings();
    } else {
        isUserSignedIn = false;
        currentUserId = null;
        document.getElementById('userIdDisplay').classList.add('hidden');
        console.log("User is signed out.");
        isParentalControlEnabled = false;
    }
});


// --- Main Initialization ---
window.addEventListener('load', async () => {
    // Initialize Firebase
    if (window.firebaseConfig && Object.keys(window.firebaseConfig).length > 0) {
        const app = firebase.initializeApp(window.firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Sign in with custom token if available, otherwise anonymously
        try {
            if (window.initialAuthToken) {
                await signInWithCustomToken(auth, window.initialAuthToken);
                console.log("Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase auth error:", error);
        }
    } else {
        console.error("Firebase config is missing. Authentication will not work.");
    }
    
    // Wire up UI events
    if (AUTH_MODAL) {
        document.getElementById('authModal').querySelector('.close-modal-btn').onclick = toggleAuthModal;
    }
    if (SIGN_IN_BTN) {
        SIGN_IN_BTN.onclick = signIn;
    }
    if (SIGN_OUT_BTN) {
        SIGN_OUT_BTN.onclick = signOutUser;
    }

    if (TOGGLE_AUTH_PASSWORD_VISIBILITY) {
        TOGGLE_AUTH_PASSWORD_VISIBILITY.onclick = () => {
            const type = AUTH_PASSWORD_INPUT.getAttribute('type') === 'password' ? 'text' : 'password';
            AUTH_PASSWORD_INPUT.setAttribute('type', type);
            TOGGLE_AUTH_PASSWORD_VISIBILITY.classList.toggle('fa-eye');
            TOGGLE_AUTH_PASSWORD_VISIBILITY.classList.toggle('fa-eye-slash');
        };
    }

    // Make functions globally accessible
    window.isUserSignedIn = isUserSignedIn;
    window.handleAuthRestrictedFeature = (featureName, panelId) => {
        if (!isUserSignedIn) {
            showCustomAlert("Please sign in to use " + featureName + ".");
            return false;
        }
        togglePanel(panelId);
        return true;
    };
    window.toggleAuthModal = toggleAuthModal;
    window.showCustomAlert = showCustomAlert;
    window.hideCustomAlert = hideCustomAlert;
    window.openParentalControlsModal = openParentalControlsModal;
    window.closeParentalControlsModal = closeParentalControlsModal;
    window.setParentCode = setParentCode;
    window.checkParentCode = checkParentCode;
    window.promptForSecurityAnswer = promptForSecurityAnswer;
});
