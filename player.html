<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Player - FLM TV</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12"></script>
    <style>
        :root {
            --primary: #ffd700;
            --secondary: #22c55e;
            --accent: #ffd700;
            --bg: #0a0f1a;
            --bg-card: #1a1f2e;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            margin: 0;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        
        /* Hide browser bars on scroll */
        html {
            overflow: hidden;
            height: 100%;
        }
        
        body {
            height: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Video container */
        #videoContainer {
            position: relative;
            width: 100%;
            height: 100vh;
            background: #000;
        }
        
        /* Video element - NATIVE CONTROLS */
        #video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        /* Loading spinner */
        #loading {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Back button */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            z-index: 1000;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-btn:hover {
            background: var(--primary);
            color: #000;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .back-btn {
                top: 10px;
                left: 10px;
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            #video {
                width: 100vw;
                height: 100vh;
            }
        }
    </style>
</head>
<body>

<a href="home.html" class="back-btn">‚Üê Back</a>

<div id="loading">
    <div class="spinner"></div>
</div>

<div id="videoContainer">
    <video id="video" controls controlsList="nodownload" playsinline preload="metadata"></video>
</div>

<!-- Firebase (for future chat integration) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Jellyfin configuration
const CONFIG = {
    SERVER: 'https://flmtv26.duckdns.org:8920',
    API_KEY: '24674385633844efbe3a1367b8f63d43',
    USER_ID: 'dd56bd60efbe4a64a4e6f866a50a6b37',
    ACCESS_TOKEN: ''
};

const video = document.getElementById('video');
const loading = document.getElementById('loading');
const urlParams = new URLSearchParams(window.location.search);
const itemId = urlParams.get('id');

// Authenticate with Jellyfin
async function authenticate() {
    try {
        const response = await fetch(`${CONFIG.SERVER}/Users/AuthenticateByName`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Emby-Authorization': `MediaBrowser Client="FLM TV", Device="Web", DeviceId="flmtv-${Date.now()}", Version="1.0.0"`
            },
            body: JSON.stringify({ Username: 'Public', Pw: '' })
        });
        
        if (response.ok) {
            const data = await response.json();
            CONFIG.ACCESS_TOKEN = data.AccessToken;
            CONFIG.USER_ID = data.User.Id;
            console.log('‚úÖ Authenticated');
            return true;
        }
    } catch (error) {
        console.error('‚ùå Auth error:', error);
    }
    return false;
}

// Get item details
async function getItemDetails() {
    const headers = {
        'X-Emby-Authorization': `MediaBrowser Client="FLM TV", Device="Web", DeviceId="flmtv-web", Version="1.0.0", Token="${CONFIG.ACCESS_TOKEN}"`
    };
    
    const url = `${CONFIG.SERVER}/Users/${CONFIG.USER_ID}/Items/${itemId}`;
    const response = await fetch(url, { headers });
    return await response.json();
}

// Play video
async function playVideo() {
    try {
        await authenticate();
        
        const item = await getItemDetails();
        console.log('üì∫ Playing:', item.Name, item.Type);
        
        // IMPORTANT: Unmute and set volume
        video.muted = false;
        video.volume = 1.0;
        
        const isEpisode = item.Type === 'Episode';
        
        if (isEpisode) {
            // Use HLS for TV episodes
            const hlsUrl = `${CONFIG.SERVER}/Videos/${itemId}/master.m3u8?api_key=${CONFIG.API_KEY}&MediaSourceId=${itemId}`;
            
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.muted = false;
                    video.volume = 1.0;
                    loading.style.display = 'none';
                    
                    // Try to play, but if blocked by browser, user can tap play
                    video.play().catch(err => {
                        console.log('‚ö†Ô∏è Autoplay blocked - tap play button');
                    });
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS Error:', data);
                    if (data.fatal) {
                        playDirectVideo();
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = hlsUrl;
                video.addEventListener('loadedmetadata', () => {
                    video.muted = false;
                    video.volume = 1.0;
                    loading.style.display = 'none';
                    video.play().catch(() => {});
                });
            } else {
                playDirectVideo();
            }
        } else {
            // Direct play for movies
            playDirectVideo();
        }
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error loading video');
        loading.style.display = 'none';
    }
}

function playDirectVideo() {
    const directUrl = `${CONFIG.SERVER}/Videos/${itemId}/stream?static=true&api_key=${CONFIG.API_KEY}`;
    video.src = directUrl;
    video.muted = false;
    video.volume = 1.0;
    loading.style.display = 'none';
    video.play().catch(() => {});
}

// Handle video errors
video.addEventListener('error', (e) => {
    console.error('Video error:', e);
    loading.style.display = 'none';
    alert('Error playing video');
});

// Hide back button when in fullscreen
document.addEventListener('fullscreenchange', () => {
    const backBtn = document.querySelector('.back-btn');
    if (document.fullscreenElement) {
        backBtn.style.display = 'none';
    } else {
        backBtn.style.display = 'inline-block';
    }
});

// Start playing
if (itemId) {
    playVideo();
} else {
    alert('No video ID provided');
    loading.style.display = 'none';
}
</script>

</body>
</html>
