<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLM TV Player</title>
    <link rel="icon" type="image/png" href="assets/logos/flm-logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- HLS.js for video streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Firebase for chat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        /* BACKDROP FLASH */
        #backdropFlash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1000;
            animation: fadeOut 2.5s ease forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; pointer-events: none; }
        }
        
        /* VIDEO CONTAINER */
        #playerContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0;
            transition: opacity 0.5s ease, width 0.3s ease;
        }
        
        #playerContainer.visible {
            opacity: 1;
        }
        
        /* Shift player left when chat is open */
        #playerContainer.chat-open {
            width: calc(100% - 450px);
        }
        
        #playerContainer.ai-open {
            width: calc(100% - 450px);
        }
        
        /* VIDEO ELEMENT */
        #videoPlayer {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain; /* Fit screen properly without cropping or zooming */
            background: #000;
        }
        
        /* CUSTOM CONTROLS */
        #customControls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
            padding: 1rem;
            opacity: 1;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        
        #playerContainer:hover #customControls,
        #customControls.show {
            opacity: 1;
        }
        
        /* Hide controls when inactive in fullscreen */
        #playerContainer.fullscreen #customControls.hide {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Keep controls visible when interacting */
        #playerContainer.fullscreen #customControls:hover {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* PROGRESS BAR */
        #progressContainer {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 1rem;
            position: relative;
        }
        
        #progressBar {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #22c55e 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        #progressHandle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            pointer-events: none;
            left: 0%;
        }
        
        /* CONTROLS ROW */
        #controlsRow {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .control-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s ease;
        }
        
        .control-btn:hover {
            color: #ffd700;
        }
        
        /* Chat Icon Button */
        .chat-icon-btn {
            width: 45px;
            height: 45px;
            background: #22c55e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            padding: 0;
        }
        
        .chat-icon-btn:hover {
            background: #16a34a;
            transform: scale(1.1);
        }
        
        /* AI Avatar Button (YOUR PHOTO!) */
        .ai-avatar-btn {
            width: 45px;
            height: 45px;
            background: #22c55e;
            border-radius: 50%;
            padding: 0;
            overflow: hidden;
            border: 3px solid #22c55e;
        }
        
        .ai-avatar-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .ai-avatar-btn:hover {
            border-color: #ffd700;
            transform: scale(1.1);
        }
        
        #playPauseBtn {
            font-size: 2rem;
        }
        
        /* VOLUME CONTROL */
        #volumeControl {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #volumeSlider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
        }
        
        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
        }
        
        #volumeSlider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        /* TIME DISPLAY */
        #timeDisplay {
            color: #fff;
            font-size: 0.9rem;
            min-width: 100px;
        }
        
        /* SPACER */
        .spacer {
            flex: 1;
        }
        
        /* QUALITY SELECTOR */
        #qualitySelect {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
        }
        
        #qualitySelect:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* BACK BUTTON */
        #backBtn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0,0,0,0.7);
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            opacity: 0;
            font-size: 1rem;
        }
        
        #backBtn.visible {
            opacity: 1;
        }
        
        #backBtn:hover {
            background: #ffd700;
            color: #000;
            transform: scale(1.05);
        }
        
        /* LOADING SPINNER */
        #loadingSpinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,215,0,0.2);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 150;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        #loadingSpinner.hidden {
            display: none;
        }
        
        /* MOBILE ADJUSTMENTS */
        @media (max-width: 768px) {
            #customControls {
                padding: 0.5rem;
            }
            
            #volumeControl {
                display: none;
            }
            
            .control-btn {
                font-size: 1.2rem;
                padding: 0.3rem;
            }
            
            #playPauseBtn {
                font-size: 1.5rem;
            }
            
            #backBtn {
                top: 0.5rem;
                left: 0.5rem;
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            #playerContainer.chat-open,
            #playerContainer.ai-open {
                width: 100%;
            }
            
            #chatPanel,
            #aiPanel {
                width: 100% !important;
            }
        }
        
        /* CHAT PANEL */
        #chatPanel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100%;
            background: rgba(10, 15, 26, 0.98);
            border-left: 2px solid #ffd700;
            z-index: 500;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        #chatPanel.open {
            right: 0;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #ffd700 0%, #22c55e 100%);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ffd700;
        }
        
        .panel-title {
            font-size: 1.25rem;
            font-weight: 900;
            color: #000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-close {
            background: transparent;
            border: 2px solid #000;
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        
        .panel-close:hover {
            background: #000;
            color: #ffd700;
        }
        
        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .chat-message {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid #22c55e;
        }
        
        .chat-message.own-message {
            background: rgba(255, 215, 0, 0.05);
            border-left: 3px solid #ffd700;
        }
        
        .chat-user {
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 0.25rem;
        }
        
        .chat-message.own-message .chat-user {
            color: #ffd700;
        }
        
        .chat-text {
            color: #fff;
        }
        
        .chat-time {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }
        
        #chatInput {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #chatInput input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 0.75rem;
            border-radius: 8px;
            outline: none;
        }
        
        #chatInput input:focus {
            border-color: #ffd700;
        }
        
        #chatInput button {
            background: linear-gradient(135deg, #ffd700 0%, #22c55e 100%);
            border: none;
            color: #000;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.2s ease;
        }
        
        #chatInput button:hover {
            transform: scale(1.05);
        }
        
        /* AI PANEL */
        #aiPanel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100%;
            background: rgba(10, 15, 26, 0.98);
            border-left: 2px solid #22c55e;
            z-index: 500;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        #aiPanel.open {
            right: 0;
        }
        
        #aiMessages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .ai-message {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }
        
        .ai-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #22c55e;
            flex-shrink: 0;
        }
        
        .ai-bubble {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            padding: 1rem;
            border-radius: 12px;
            flex: 1;
        }
        
        .user-message {
            justify-content: flex-end;
        }
        
        .user-bubble {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
        }
        
        .ai-text {
            color: #fff;
            line-height: 1.6;
        }
        
        #aiInput {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #aiInput input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 0.75rem;
            border-radius: 8px;
            outline: none;
        }
        
        #aiInput input:focus {
            border-color: #22c55e;
        }
        
        #aiInput button {
            background: linear-gradient(135deg, #22c55e 0%, #ffd700 100%);
            border: none;
            color: #000;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.2s ease;
        }
        
        #aiInput button:hover {
            transform: scale(1.05);
        }
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /*  SIDE PANELS (Chat & AI)                                        */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        .side-panel {
            position: fixed;
            right: -100%;
            top: 0;
            width: 100%;
            max-width: 450px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 3px solid var(--primary);
            z-index: 9998;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .side-panel.active {
            right: 0;
        }
        
        .panel-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--neon-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.95);
        }
        
        .panel-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--neon-green);
        }
        
        .panel-close {
            background: none;
            border: none;
            color: var(--neon-green);
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .panel-close:hover {
            background: var(--neon-green);
            color: white;
            transform: rotate(90deg);
        }
        
        .panel-toggle {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .panel-toggle:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Fullscreen panel mode */
        .side-panel.panel-fullscreen {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .panel-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
    </style>
</head>
<body>
    
    <!-- BACKDROP FLASH -->
    <div id="backdropFlash"></div>
    
    <!-- BACK BUTTON -->
    <button id="backBtn" onclick="goBack()">
        ‚Üê Back
    </button>
    
    <!-- VIDEO PLAYER CONTAINER -->
    <div id="playerContainer">
        <video id="videoPlayer" playsinline></video>
        
        <!-- LOADING SPINNER -->
        <div id="loadingSpinner"></div>
        
        <!-- CUSTOM CONTROLS -->
        <div id="customControls">
            <!-- Progress Bar -->
            <div id="progressContainer">
                <div id="progressBar"></div>
                <div id="progressHandle"></div>
            </div>
            
            <!-- Controls Row -->
            <div id="controlsRow">
                <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂</button>
                
                <!-- Volume -->
                <div id="volumeControl">
                    <button class="control-btn" id="volumeBtn" onclick="toggleMute()">üîä</button>
                    <input type="range" id="volumeSlider" min="0" max="100" value="100">
                </div>
                
                <!-- Time -->
                <div id="timeDisplay">0:00 / 0:00</div>
                
                <div class="spacer"></div>
                
                <!-- Quality Selector -->
                <select id="qualitySelect">
                    <option value="auto">Auto</option>
                </select>
                
                <!-- Chapters Button -->
                <button class="control-btn" id="chaptersBtn" onclick="toggleChapters()" title="Chapters" style="display:none;">
                    <i class="fas fa-list"></i>
                </button>
                
                <!-- Previous Episode -->
                <button class="control-btn" id="prevEpisodeBtn" onclick="playPreviousEpisode()" title="Previous Episode" style="display:none;">
                    <i class="fas fa-step-backward"></i>
                </button>
                
                <!-- Next Episode -->
                <button class="control-btn" id="nextEpisodeBtn" onclick="playNextEpisode()" title="Next Episode" style="display:none;">
                    <i class="fas fa-step-forward"></i>
                </button>
                
                <!-- Chat Button (matches your design!) -->
                <button class="control-btn chat-icon-btn" id="chatBtn" onclick="openPanel('chatPanel')" title="Live Chat">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                    </svg>
                </button>
                
                <!-- AI Button (YOUR PHOTO!) -->
                <button class="control-btn ai-avatar-btn" id="aiBtn" onclick="openPanel('aiPanel')" title="Ask Zaina">
                    <img src="assets/images/z-ai-avatar2.png" alt="Zaina AI">
                </button>
                
                <!-- Fullscreen -->
                <button class="control-btn" id="fullscreenBtn" onclick="toggleFullscreen()">‚õ∂</button>
            </div>
        </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!--  YOUR ACTUAL CHAT PANEL (from home page)                       -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    
    <div class="side-panel" id="chatPanel">
        <div class="panel-header">
            <div>
                <h3 class="panel-title" style="margin-bottom: 0.25rem;"><i class="fas fa-comments"></i> Live Chat</h3>
                <p style="font-size: 0.75rem; color: #b3b3b3; margin: 0;">Chat with viewers worldwide üåç</p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="panel-toggle" onclick="togglePanelFullscreen('chatPanel')" title="Expand Panel">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="panel-close" onclick="closePanel('chatPanel')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Simple Username Input -->
        <div style="padding: 0.75rem; background: #282828; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 0.5rem;">
            <label style="font-size: 0.85rem; color: #b3b3b3; white-space: nowrap;">Name:</label>
            <input type="text" id="chatUsernameInput" placeholder="Enter your name" 
                   style="flex: 1; padding: 0.5rem; background: #1a1a1a; border: 1px solid #444; border-radius: 6px; color: white; font-size: 0.9rem;"
                   maxlength="20">
        </div>
        
        <div class="chat-messages" id="chatMessages" style="flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #1a1a1a;">
        </div>
        
        <div class="chat-input-area" style="background-color: #282828; padding: 1rem; border-top: 1px solid #333; display: flex; align-items: center; gap: 0.5rem; position: sticky; bottom: 0; flex-shrink: 0;">
            <textarea id="chatInput" class="chat-input" placeholder="Type your message..." style="flex-grow: 1; padding: 0.75rem; border-radius: 1.5rem; border: 1px solid #444; background-color: #333; color: white; outline: none; font-size: 1em; resize: none; min-height: 40px; max-height: 100px; overflow-y: auto; font-family: inherit;"></textarea>
            <button id="emojiBtn" class="chat-btn" style="background-color: var(--secondary); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2em; flex-shrink: 0;">üòÄ</button>
            <button id="sendBtn" class="chat-btn" style="background-color: var(--secondary); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2em; flex-shrink: 0;">
                <i class="fas fa-paper-plane"></i>
            </button>
            <div id="emojiPicker" class="emoji-picker" style="position: absolute; bottom: calc(100% + 10px); left: 0; right: 0; background-color: #282828; border-radius: 8px; box-shadow: 0 -5px 15px rgba(0,0,0,0.4); padding: 1rem; display: none; flex-wrap: wrap; gap: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 10;"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!--  CHAPTERS PANEL                                                 -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    
    <div id="chaptersPanel" style="display:none; position: absolute; bottom: 80px; right: 20px; background: rgba(0,0,0,0.95); border: 2px solid #ffd700; border-radius: 12px; padding: 1rem; max-height: 400px; overflow-y: auto; min-width: 300px; z-index: 200;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ffd700;">
            <h3 style="color: #ffd700; margin: 0; font-size: 1.2rem;">
                <i class="fas fa-list"></i> Chapters
            </h3>
            <button onclick="toggleChapters()" style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">√ó</button>
        </div>
        <div id="chaptersList"></div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!--  YOUR ACTUAL ZAINA AI PANEL (from home page)                   -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    
    <div class="side-panel" id="aiPanel">
        <div class="panel-header">
            <h3 class="panel-title"><i class="fas fa-robot"></i> Zaina J AI</h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="panel-toggle" onclick="togglePanelFullscreen('aiPanel')" title="Expand Panel">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="panel-close" onclick="closePanel('aiPanel')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="panel-body" style="padding: 1.5rem; overflow-y: auto; flex-grow: 1;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <img src="assets/images/z-ai-avatar2.png" alt="Zaina AI" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent);">
                <div>
                    <h4 style="color: var(--accent); font-weight: 700; margin-bottom: 0.25rem;">Zaina J AI</h4>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">Your Entertainment Assistant</p>
                </div>
            </div>
            
            <!-- ZAINA AI Assistant Search -->
            <div style="background: rgba(255, 215, 0, 0.05); border: 2px solid var(--accent); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    Search YouTube for trailers, auto-fill metadata, and preview posters.
                </p>
                <label style="color: var(--text); font-weight: 600; margin-bottom: 0.5rem; display: block;">
                    üé¨ Search Film or Trailer:
                </label>
                <input id="lumaSearch" placeholder="Enter film title..." 
                       onkeypress="if(event.key === 'Enter') searchYouTube()"
                       style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255, 215, 0, 0.3); font-family: inherit; margin-bottom: 1rem;">
                <button onclick="searchYouTube()" 
                        style="width: 100%; background: var(--accent); color: #000; padding: 0.75rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 700; font-size: 1rem;">
                    üîç Search YouTube
                </button>
                <div id="lumaResults" style="margin-top: 1.5rem;"></div>
            </div>
            
            <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--text);">
                Search film info, trailers, actors...
            </h3>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem;">
                <input type="text" id="aiSearchInput" placeholder="Search film..." 
                       style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; background: #333; color: white; border: 1px solid #444; font-family: inherit;">
                <button id="aiSearchButton" 
                        style="background: var(--secondary); color: white; padding: 0.75rem 1.25rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-search"></i><span class="search-text"> Search</span>
                </button>
            </div>
            
            <!-- AI Chat Messages Area -->
            <div style="border-top: 1px solid #333; padding-top: 1.5rem; margin-top: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--neon-green);">
                    Chat with Zaina AI
                </h3>
                <div id="aiMessages" class="chat-messages" style="background-color: #1a1a1a; border-radius: 8px; padding: 1rem; min-height: 200px; max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    <div class="message received">
                        <div class="message-bubble">üëã Hi! I'm Zaina AI. Ask me anything about movies, TV shows, or entertainment!</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Chat Input Area -->
        <div class="chat-input-area" style="background-color: #282828; padding: 1rem; border-top: 1px solid #333; display: flex; align-items: center; gap: 0.5rem;">
            <textarea id="aiChatInput" class="chat-input" placeholder="Ask Zaina AI anything..." style="flex-grow: 1; padding: 0.75rem; border-radius: 1.5rem; border: 1px solid #444; background-color: #333; color: white; outline: none; font-size: 1em; resize: none; min-height: 40px; max-height: 100px; overflow-y: auto; font-family: inherit;"></textarea>
            <button id="aiSendBtn" class="chat-btn" style="background-color: var(--accent); color: #000; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2em; flex-shrink: 0;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');
        const itemType = urlParams.get('type');
        
        const JELLYFIN_CONFIG = {
            SERVER: 'https://flmtv26.duckdns.org:8920',
            API_KEY: '62131ee22c0141c6b651be75a7444350',
            USER_ID: '0407d4609a0346f99c09e0d7ddc9ccd1'
        };
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD871FYC8vGc7JAAw-2rGMZBB_h4sI0HpQ",
            authDomain: "flmtv-site-counter.firebaseapp.com",
            databaseURL: "https://flmtv-site-counter-default-rtdb.firebaseio.com",
            projectId: "flmtv-site-counter",
            storageBucket: "flmtv-site-counter.firebasestorage.app",
            messagingSenderId: "480859127361",
            appId: "1:480859127361:web:2cb3b8c51c7e1e5d9c8f7e"
        };
        
        const GEMINI_API_KEY = 'AIzaSyD871FYC8vGc7JAAw-2rGMZBB_h4sI0HpQ';
        
        // Initialize Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Anonymous authentication
        auth.signInAnonymously().catch(error => console.error('Auth error:', error));
        
        const video = document.getElementById('videoPlayer');
        const playerContainer = document.getElementById('playerContainer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const progressHandle = document.getElementById('progressHandle');
        const progressContainer = document.getElementById('progressContainer');
        const timeDisplay = document.getElementById('timeDisplay');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeBtn = document.getElementById('volumeBtn');
        const customControls = document.getElementById('customControls');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const backBtn = document.getElementById('backBtn');
        
        let hls = null;
        let hideControlsTimeout = null;
        
        async function jellyfinFetch(endpoint, params = {}) {
            const queryString = new URLSearchParams({
                api_key: JELLYFIN_CONFIG.API_KEY,
                ...params
            }).toString();
            
            const url = `${JELLYFIN_CONFIG.SERVER}${endpoint}?${queryString}`;
            const response = await fetch(url);
            return response.json();
        }
        
        async function authenticatePublic() {
            try {
                const response = await fetch(`${JELLYFIN_CONFIG.SERVER}/Users/AuthenticateByName`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Emby-Authorization': `MediaBrowser Client="FLM TV Web", Device="Browser", DeviceId="flmtv-web", Version="1.0.0"`
                    },
                    body: JSON.stringify({
                        Username: 'Public',
                        Pw: ''
                    })
                });
                
                const data = await response.json();
                console.log('‚úÖ Authenticated as Public');
                return data.AccessToken;
            } catch (error) {
                console.error('Authentication error:', error);
            }
        }
        
        async function loadPlayer() {
            try {
                // Authenticate
                await authenticatePublic();
                
                // Fetch item for backdrop
                const item = await jellyfinFetch(`/Users/${JELLYFIN_CONFIG.USER_ID}/Items/${itemId}`);
                
                // Set backdrop
                const backdrop = document.getElementById('backdropFlash');
                if (item.BackdropImageTags && item.BackdropImageTags.length > 0) {
                    backdrop.style.backgroundImage = 
                        `url('${JELLYFIN_CONFIG.SERVER}/Items/${itemId}/Images/Backdrop?api_key=${JELLYFIN_CONFIG.API_KEY}&tag=${item.BackdropImageTags[0]}&quality=90')`;
                } else if (item.ImageTags && item.ImageTags.Primary) {
                    backdrop.style.backgroundImage = 
                        `url('${JELLYFIN_CONFIG.SERVER}/Items/${itemId}/Images/Primary?api_key=${JELLYFIN_CONFIG.API_KEY}&quality=90')`;
                }
                
                // Get video stream URL - Try multiple formats
                console.log('üé¨ Attempting to load video stream...');
                
                // Option 1: Try direct stream first (most compatible)
                const directStreamUrl = `${JELLYFIN_CONFIG.SERVER}/Videos/${itemId}/stream?Static=true&api_key=${JELLYFIN_CONFIG.API_KEY}`;
                
                // Option 2: HLS stream (for adaptive bitrate)
                const hlsStreamUrl = `${JELLYFIN_CONFIG.SERVER}/Videos/${itemId}/master.m3u8?api_key=${JELLYFIN_CONFIG.API_KEY}&mediaSourceId=${itemId}`;
                
                // Option 3: Universal stream endpoint
                const universalStreamUrl = `${JELLYFIN_CONFIG.SERVER}/Videos/${itemId}/stream?api_key=${JELLYFIN_CONFIG.API_KEY}&Static=false&MediaSourceId=${itemId}&DeviceId=flmtv-player&VideoCodec=h264,hevc&AudioCodec=aac,mp3`;
                
                console.log('üì∫ Direct Stream URL:', directStreamUrl);
                console.log('üì∫ HLS Stream URL:', hlsStreamUrl);
                console.log('üì∫ Universal Stream URL:', universalStreamUrl);
                
                // Initialize player after backdrop fades
                setTimeout(() => {
                    // Try HLS first (best for 4K)
                    initializeVideoPlayer(hlsStreamUrl, directStreamUrl);
                    playerContainer.classList.add('visible');
                    backBtn.classList.add('visible');
                    
                    // Load chapters and episode navigation
                    loadChapters();
                    loadEpisodeNavigation();
                }, 2500);
                
            } catch (error) {
                console.error('Error loading player:', error);
                alert('Error loading video. Please try again.');
            }
        }
        
        function initializeVideoPlayer(hlsUrl, fallbackUrl) {
            console.log('üé• Initializing video player...');
            console.log('üé• Primary (HLS):', hlsUrl);
            console.log('üé• Fallback (Direct):', fallbackUrl);
            
            // Check if HLS is supported natively (Safari)
            if (video.canPlayType('application/vnd.apple.mpegurl')) {
                console.log('‚úÖ Native HLS support detected (Safari/iOS)');
                video.src = hlsUrl;
                setupVideoEvents();
                
                // If HLS fails, try direct stream
                video.addEventListener('error', (e) => {
                    console.error('‚ùå HLS stream failed:', e);
                    console.log('üîÑ Trying direct stream fallback...');
                    video.src = fallbackUrl;
                }, { once: true });
            } 
            // Use HLS.js for other browsers
            else if (Hls.isSupported()) {
                console.log('‚úÖ HLS.js support detected');
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    debug: true // Enable debug logging
                });
                
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log('‚úÖ HLS manifest parsed successfully');
                    loadingSpinner.classList.add('hidden');
                    video.play().catch(e => {
                        console.log('‚ö†Ô∏è Autoplay prevented:', e);
                        // Show play button overlay if autoplay fails
                    });
                    
                    // Populate quality selector
                    populateQualityOptions();
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('‚ùå HLS Error:', data);
                    
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log('üîÑ Network error, trying to recover...');
                                hls.startLoad();
                                
                                // If recovery fails, try direct stream
                                setTimeout(() => {
                                    if (video.readyState === 0) {
                                        console.log('üîÑ Recovery failed, switching to direct stream...');
                                        tryDirectStream(fallbackUrl);
                                    }
                                }, 3000);
                                break;
                                
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('üîÑ Media error, trying to recover...');
                                hls.recoverMediaError();
                                break;
                                
                            default:
                                console.log('‚ùå Fatal error, switching to direct stream...');
                                tryDirectStream(fallbackUrl);
                                break;
                        }
                    }
                });
                
                setupVideoEvents();
            } else {
                console.log('‚ö†Ô∏è No HLS support, using direct stream');
                tryDirectStream(fallbackUrl);
            }
        }
        
        function tryDirectStream(url) {
            console.log('üé• Loading direct stream:', url);
            
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            video.src = url;
            setupVideoEvents();
            
            video.addEventListener('loadeddata', () => {
                console.log('‚úÖ Direct stream loaded successfully');
                loadingSpinner.classList.add('hidden');
                video.play().catch(e => console.log('‚ö†Ô∏è Autoplay prevented:', e));
            }, { once: true });
            
            video.addEventListener('error', (e) => {
                console.error('‚ùå Direct stream also failed:', e);
                loadingSpinner.classList.add('hidden');
                
                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;text-align:center;padding:2rem;background:rgba(0,0,0,0.8);border-radius:12px;max-width:80%;';
                errorDiv.innerHTML = `
                    <h2 style="color:#ffd700;margin-bottom:1rem;">Unable to Load Video</h2>
                    <p style="margin-bottom:1rem;">The video stream could not be loaded. This might be due to:</p>
                    <ul style="text-align:left;margin-bottom:1rem;">
                        <li>Video file format not supported</li>
                        <li>HTTPS certificate issues</li>
                        <li>Network connectivity problems</li>
                        <li>Jellyfin server unavailable</li>
                    </ul>
                    <button onclick="location.reload()" style="background:#22c55e;color:#000;border:none;padding:0.75rem 2rem;border-radius:25px;font-weight:700;cursor:pointer;">Try Again</button>
                    <button onclick="goBack()" style="background:#ffd700;color:#000;border:none;padding:0.75rem 2rem;border-radius:25px;font-weight:700;cursor:pointer;margin-left:1rem;">Go Back</button>
                `;
                playerContainer.appendChild(errorDiv);
            }, { once: true });
        }
        
        function setupVideoEvents() {
            // Update progress bar
            video.addEventListener('timeupdate', updateProgress);
            
            // Update duration
            video.addEventListener('loadedmetadata', () => {
                updateTimeDisplay();
            });
            
            // Play/Pause button
            video.addEventListener('play', () => {
                playPauseBtn.textContent = '‚è∏';
            });
            
            video.addEventListener('pause', () => {
                playPauseBtn.textContent = '‚ñ∂';
            });
            
            // Loading states
            video.addEventListener('waiting', () => {
                loadingSpinner.classList.remove('hidden');
            });
            
            video.addEventListener('playing', () => {
                loadingSpinner.classList.add('hidden');
            });
            
            // Auto-hide controls in fullscreen (professional behavior)
            let hideControlsTimeout;
            let isFullscreen = false;
            
            function showControls() {
                customControls.classList.remove('hide');
                customControls.classList.add('show');
                
                // Reset hide timer
                clearTimeout(hideControlsTimeout);
                
                // Auto-hide after 3 seconds if in fullscreen and playing
                if (isFullscreen && !video.paused) {
                    hideControlsTimeout = setTimeout(() => {
                        customControls.classList.add('hide');
                        customControls.classList.remove('show');
                    }, 3000);
                }
            }
            
            function hideControls() {
                if (isFullscreen && !video.paused) {
                    customControls.classList.add('hide');
                    customControls.classList.remove('show');
                }
            }
            
            // Show controls on mouse move
            playerContainer.addEventListener('mousemove', showControls);
            
            // Show controls on touch (mobile/TV)
            playerContainer.addEventListener('touchstart', showControls);
            
            // Show controls when touching bottom 25% of screen
            playerContainer.addEventListener('touchend', (e) => {
                const touch = e.changedTouches[0];
                const containerRect = playerContainer.getBoundingClientRect();
                const touchY = touch.clientY - containerRect.top;
                const bottomZone = containerRect.height * 0.75; // Bottom 25%
                
                if (touchY > bottomZone) {
                    showControls();
                }
            });
            
            // Track fullscreen state
            document.addEventListener('fullscreenchange', () => {
                isFullscreen = !!document.fullscreenElement;
                if (!isFullscreen) {
                    showControls(); // Always show controls when exiting fullscreen
                    clearTimeout(hideControlsTimeout);
                }
            });
            
            // Hide controls on play if in fullscreen
            video.addEventListener('play', () => {
                if (isFullscreen) {
                    hideControlsTimeout = setTimeout(hideControls, 3000);
                }
            });
            
            // Show controls on pause
            video.addEventListener('pause', showControls);
        }
        
        function populateQualityOptions() {
            if (hls && hls.levels.length > 0) {
                const qualitySelect = document.getElementById('qualitySelect');
                qualitySelect.innerHTML = '<option value="-1">Auto</option>';
                
                hls.levels.forEach((level, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${level.height}p`;
                    qualitySelect.appendChild(option);
                });
                
                qualitySelect.addEventListener('change', (e) => {
                    hls.currentLevel = parseInt(e.target.value);
                });
            }
        }
        
        function togglePlayPause() {
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }
        
        function updateProgress() {
            const percent = (video.currentTime / video.duration) * 100;
            progressBar.style.width = percent + '%';
            progressHandle.style.left = percent + '%';
            updateTimeDisplay();
        }
        
        function updateTimeDisplay() {
            const current = formatTime(video.currentTime);
            const duration = formatTime(video.duration);
            timeDisplay.textContent = `${current} / ${duration}`;
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            
            if (h > 0) {
                return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        // Progress bar seeking
        progressContainer.addEventListener('click', (e) => {
            const rect = progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            video.currentTime = percent * video.duration;
        });
        
        // Volume control
        volumeSlider.addEventListener('input', (e) => {
            video.volume = e.target.value / 100;
            updateVolumeIcon();
        });
        
        function toggleMute() {
            video.muted = !video.muted;
            updateVolumeIcon();
        }
        
        function updateVolumeIcon() {
            if (video.muted || video.volume === 0) {
                volumeBtn.textContent = 'üîá';
            } else if (video.volume < 0.5) {
                volumeBtn.textContent = 'üîâ';
            } else {
                volumeBtn.textContent = 'üîä';
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                playerContainer.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function goBack() {
            if (hls) {
                hls.destroy();
            }
            window.history.back();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'f':
                case 'F':
                    toggleFullscreen();
                    break;
                case 'ArrowLeft':
                    video.currentTime -= 10;
                    break;
                case 'ArrowRight':
                    video.currentTime += 10;
                    break;
                case 'm':
                case 'M':
                    toggleMute();
                    break;
            }
        });
        
        // Initialize
        if (itemId) {
            loadPlayer();
        } else {
            alert('No video ID provided');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHAT FUNCTIONALITY (Same as home page!)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let chatOpen = false;
        let aiOpen = false;
        let displayedMessages = new Set();
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANEL CONTROL FUNCTIONS (from home page)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function openPanel(panelId) {
            console.log('üî• Opening panel:', panelId);
            
            // Close other panels
            document.querySelectorAll('.side-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('active');
                console.log('‚úÖ Panel opened:', panelId);
                
                // If opening chat panel, load saved username
                if (panelId === 'chatPanel') {
                    const savedUsername = localStorage.getItem('flmtvChatUsername');
                    const usernameInput = document.getElementById('chatUsernameInput');
                    if (savedUsername && usernameInput) {
                        usernameInput.value = savedUsername;
                    }
                }
            } else {
                console.error('‚ùå Panel not found:', panelId);
            }
            
            // Push content left when panel opens
            document.body.classList.add('panel-active');
        }
        
        function closePanel(panelId) {
            const panel = document.getElementById(panelId);
            panel.classList.remove('active');
            panel.classList.remove('panel-fullscreen');  // Reset fullscreen when closing
            
            // Reset toggle button icon
            const toggleBtn = panel.querySelector('.panel-toggle i');
            if (toggleBtn) {
                toggleBtn.className = 'fas fa-expand';
            }
            
            // Remove body padding when panel closes
            document.body.classList.remove('panel-active');
        }
        
        function togglePanelFullscreen(panelId) {
            const panel = document.getElementById(panelId);
            const toggleBtn = panel.querySelector('.panel-toggle i');
            
            if (panel.classList.contains('panel-fullscreen')) {
                // Exit fullscreen - back to side panel (450px)
                panel.classList.remove('panel-fullscreen');
                toggleBtn.className = 'fas fa-expand';
                console.log('‚úÖ Panel back to side mode:', panelId);
            } else {
                // Enter fullscreen - panel takes full width
                panel.classList.add('panel-fullscreen');
                toggleBtn.className = 'fas fa-compress';
                console.log('‚úÖ Panel fullscreen mode:', panelId);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHAT FUNCTIONALITY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            
            // Use SAME Firebase path as home page: 'messages'
            const chatRef = database.ref('messages').limitToLast(50);
            
            // Listen for new messages (YOUTUBE STYLE - everyone sees everything)
            chatRef.on('child_added', (snapshot) => {
                const messageId = snapshot.key;
                const msg = snapshot.val();
                
                // Prevent duplicate messages
                if (displayedMessages.has(messageId)) {
                    return;
                }
                displayedMessages.add(messageId);
                
                // Show ALL messages to EVERYONE
                if (msg && msg.text) {
                    const username = msg.username || `Viewer${msg.userId ? msg.userId.substring(0, 6) : '???'}`;
                    
                    // Check if this is from current user
                    let isOwnMessage = false;
                    const savedUsername = localStorage.getItem('flmtvChatUsername');
                    if (savedUsername && msg.username === savedUsername) {
                        isOwnMessage = true;
                    } else if (auth.currentUser && msg.userId === auth.currentUser.uid) {
                        isOwnMessage = true;
                    }
                    
                    displayChatMessage(msg, username, isOwnMessage);
                }
            });
        }
        
        function displayChatMessage(message, username, isOwn) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message' + (isOwn ? ' own-message' : '');
            messageDiv.innerHTML = `
                <div class="chat-user" style="color: ${isOwn ? '#ffd700' : '#22c55e'};">${username}</div>
                <div class="chat-text">${escapeHtml(message.text)}</div>
                <div class="chat-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Get or create username
            let username = localStorage.getItem('flmtvChatUsername');
            if (!username) {
                username = `Viewer${Math.random().toString(36).substring(2, 8)}`;
                localStorage.setItem('flmtvChatUsername', username);
            }
            
            const message = {
                username: username,
                userId: auth.currentUser ? auth.currentUser.uid : 'anonymous',
                text: text,
                timestamp: Date.now()
            };
            
            // Use SAME Firebase path as home page: 'messages'
            database.ref('messages').push(message);
            input.value = '';
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AI ASSISTANT FUNCTIONALITY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        async function sendAIMessage() {
            const input = document.getElementById('aiMessageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Display user message
            displayAIMessage(text, true);
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <img src="assets/images/z-ai-avatar2.png" alt="Zaina AI" class="ai-avatar">
                <div class="ai-bubble">
                    <div class="ai-text">Zaina is typing...</div>
                </div>
            `;
            document.getElementById('aiMessages').appendChild(typingDiv);
            
            try {
                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are Zaina, the AI assistant for FLM TV, a multicultural television network. You're friendly, helpful, and knowledgeable about entertainment, movies, TV shows, and FLM TV's content. Keep responses concise and engaging. User question: ${text}`
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Display AI response
                displayAIMessage(aiResponse, false);
                
            } catch (error) {
                console.error('AI Error:', error);
                typingDiv.remove();
                displayAIMessage("Sorry, I'm having trouble connecting right now. Please try again!", false);
            }
        }
        
        function displayAIMessage(text, isUser) {
            const aiMessages = document.getElementById('aiMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'ai-message user-message' : 'ai-message';
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="ai-bubble user-bubble">
                        <div class="ai-text">${escapeHtml(text)}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <img src="assets/images/z-ai-avatar2.png" alt="Zaina AI" class="ai-avatar">
                    <div class="ai-bubble">
                        <div class="ai-text">${escapeHtml(text)}</div>
                    </div>
                `;
            }
            
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHAPTERS FUNCTIONALITY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentChapters = [];
        
        function toggleChapters() {
            const panel = document.getElementById('chaptersPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        async function loadChapters() {
            try {
                const itemId = urlParams.get('id');
                const response = await jellyfinFetch(`/Users/${JELLYFIN_CONFIG.USER_ID}/Items/${itemId}`);
                
                if (response.Chapters && response.Chapters.length > 0) {
                    currentChapters = response.Chapters;
                    document.getElementById('chaptersBtn').style.display = 'inline-flex';
                    displayChapters();
                } else {
                    document.getElementById('chaptersBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading chapters:', error);
            }
        }
        
        function displayChapters() {
            const chaptersList = document.getElementById('chaptersList');
            chaptersList.innerHTML = currentChapters.map((chapter, index) => `
                <div onclick="seekToChapter(${chapter.StartPositionTicks / 10000000})" 
                     style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.2s; border-left: 3px solid #22c55e;"
                     onmouseover="this.style.background='rgba(34,197,94,0.2)'"
                     onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                    <div style="font-weight: 600; color: #ffd700; margin-bottom: 0.25rem;">
                        ${chapter.Name || `Chapter ${index + 1}`}
                    </div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">
                        ${formatTime(chapter.StartPositionTicks / 10000000)}
                    </div>
                </div>
            `).join('');
        }
        
        function seekToChapter(timeInSeconds) {
            video.currentTime = timeInSeconds;
            toggleChapters(); // Close panel after selecting
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EPISODE NAVIGATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentEpisodeData = null;
        let allEpisodes = [];
        let currentEpisodeIndex = -1;
        
        async function loadEpisodeNavigation() {
            try {
                const itemId = urlParams.get('id');
                const item = await jellyfinFetch(`/Users/${JELLYFIN_CONFIG.USER_ID}/Items/${itemId}`);
                
                // Check if this is an episode
                if (item.Type === 'Episode') {
                    currentEpisodeData = item;
                    
                    // Load all episodes in the season
                    const episodes = await jellyfinFetch(`/Shows/${item.SeriesId}/Episodes`, {
                        SeasonId: item.SeasonId,
                        UserId: JELLYFIN_CONFIG.USER_ID,
                        Fields: 'Overview'
                    });
                    
                    allEpisodes = episodes.Items || [];
                    currentEpisodeIndex = allEpisodes.findIndex(ep => ep.Id === itemId);
                    
                    // Show/hide navigation buttons
                    const prevBtn = document.getElementById('prevEpisodeBtn');
                    const nextBtn = document.getElementById('nextEpisodeBtn');
                    
                    if (currentEpisodeIndex > 0) {
                        prevBtn.style.display = 'inline-flex';
                    }
                    
                    if (currentEpisodeIndex < allEpisodes.length - 1) {
                        nextBtn.style.display = 'inline-flex';
                    }
                }
            } catch (error) {
                console.error('Error loading episode navigation:', error);
            }
        }
        
        function playPreviousEpisode() {
            if (currentEpisodeIndex > 0) {
                const prevEpisode = allEpisodes[currentEpisodeIndex - 1];
                window.location.href = `player.html?id=${prevEpisode.Id}`;
            }
        }
        
        function playNextEpisode() {
            if (currentEpisodeIndex < allEpisodes.length - 1) {
                const nextEpisode = allEpisodes[currentEpisodeIndex + 1];
                window.location.href = `player.html?id=${nextEpisode.Id}`;
            }
        }
        
        // Auto-play next episode when current ends
        video.addEventListener('ended', () => {
            if (currentEpisodeIndex >= 0 && currentEpisodeIndex < allEpisodes.length - 1) {
                // Show "Next Episode" overlay for 5 seconds
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);padding:2rem;border-radius:12px;text-align:center;z-index:300;border:3px solid #ffd700;';
                overlay.innerHTML = `
                    <h2 style="color:#ffd700;margin-bottom:1rem;">Episode Complete!</h2>
                    <p style="color:#fff;margin-bottom:1.5rem;">Playing next episode in <span id="countdown">5</span> seconds...</p>
                    <button onclick="playNextEpisode()" style="background:#22c55e;color:#000;border:none;padding:0.75rem 2rem;border-radius:25px;font-weight:700;cursor:pointer;margin-right:1rem;">Play Now</button>
                    <button onclick="this.parentElement.remove()" style="background:#fff;color:#000;border:none;padding:0.75rem 2rem;border-radius:25px;font-weight:700;cursor:pointer;">Cancel</button>
                `;
                playerContainer.appendChild(overlay);
                
                let countdown = 5;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    const countdownEl = document.getElementById('countdown');
                    if (countdownEl) countdownEl.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        playNextEpisode();
                    }
                }, 1000);
                
                // Cancel autoplay if user interacts
                overlay.querySelector('button:last-child').addEventListener('click', () => {
                    clearInterval(countdownInterval);
                });
            }
        });
        
        async function jellyfinFetch(endpoint, params = {}) {
            const queryString = new URLSearchParams({
                api_key: JELLYFIN_CONFIG.API_KEY,
                ...params
            }).toString();
            
            const url = `${JELLYFIN_CONFIG.SERVER}${endpoint}?${queryString}`;
            const response = await fetch(url);
            return response.json();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EMOJI PICKER & SEND BUTTON INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const send Btn = document.getElementById('sendBtn');
        const chatInput = document.getElementById('chatInput');
        
        const emojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò©', 'üò´', 'üò§', 'üò†', 'üò°', 'ü§¨', 'üòà', 'üëø', 'üíÄ', 'üëª', 'üí©', 'ü§°', 'üëπ', 'üë∫', 'üëΩ', 'üëæ', 'ü§ñ', 'üëã', 'ü§ö', '‚úã', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'üëè', 'üôå', 'üëê', 'ü§≤', 'üôè', 'üí™', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'ü§é', 'üñ§', 'ü§ç', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üî•', 'üíß', 'üí®', 'üé∂', 'üéµ', 'üíØ'];
        
        // Populate emoji picker
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.textContent = emoji;
            span.style.fontSize = '1.5em';
            span.style.cursor = 'pointer';
            span.style.padding = '0.2rem';
            span.style.borderRadius = '4px';
            span.addEventListener('click', () => {
                chatInput.value += emoji;
                chatInput.focus();
                emojiPicker.style.display = 'none';
            });
            span.addEventListener('mouseenter', (e) => e.target.style.backgroundColor = '#3e3e3e');
            span.addEventListener('mouseleave', (e) => e.target.style.backgroundColor = 'transparent');
            emojiPicker.appendChild(span);
        });
        
        // Toggle emoji picker
        if (emojiBtn && emojiPicker) {
            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
            });
            
            // Close emoji picker when clicking outside
            document.addEventListener('click', (e) => {
                if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.style.display = 'none';
                }
            });
        }
        
        // Send button click
        if (sendBtn && chatInput) {
            sendBtn.addEventListener('click', () => {
                const text = chatInput.value.trim();
                if (text) {
                    sendMessage(text);
                    chatInput.value = '';
                    emojiPicker.style.display = 'none';
                }
            });
            
            // Enter to send
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });
        }
        
        // AI Send button
        const aiSendBtn = document.getElementById('aiSendBtn');
        const aiChatInput = document.getElementById('aiChatInput');
        
        if (aiSendBtn && aiChatInput) {
            aiSendBtn.addEventListener('click', () => {
                const text = aiChatInput.value.trim();
                if (text) {
                    // Add AI message handling here
                    console.log('AI message:', text);
                    aiChatInput.value = '';
                }
            });
            
            aiChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    aiSendBtn.click();
                }
            });
        }
        
        // Auto-load chat messages when panel opens
        openPanel = (function() {
            const original = openPanel;
            return function(panelId) {
                original(panelId);
                if (panelId === 'chatPanel') {
                    loadChatMessages();
                }
            };
        })();
    </script>
    
</body>
</html>
