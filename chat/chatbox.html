<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLM TV Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #ffffff; /* White text */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 10px 0 0 0; /* Top padding, no side or bottom padding here */
            box-sizing: border-box;
            background-color: #282828; /* Slightly lighter than body for contrast */
            border-radius: 8px;
            margin: 5px; /* Margin to keep it slightly off the edges if needed by iframe */
            overflow: hidden; /* To handle internal scrolling */
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for messages */
            padding: 0 10px 10px 10px; /* Padding for messages, including right for scrollbar */
            word-wrap: break-word; /* Wrap long words */
            background-color: #1a1a1a; /* Corrected: Dark background for messages area */
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Messages appear from bottom */
        }

        /* Message styling */
        .message {
            background-color: #3a3a3a; /* Darker background for messages */
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 80%;
            align-self: flex-start;
            word-wrap: break-word;
        }

        /* Styles for sent messages */
        .message.sent {
            background-color: #007bff; /* A distinct color for sent messages */
            align-self: flex-end;
        }

        .timestamp {
            font-size: 0.7em;
            color: #b3b3b3;
            margin-top: 4px;
            text-align: right; /* For sent messages */
        }

        .message.received .timestamp {
            text-align: left;
        }

        /* Chat Input Area */
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #333; /* A separator */
            background-color: #282828; /* Background for the input area */
        }

        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 5px;
            margin-right: 10px;
            background-color: #282828; /* Corrected: Dark background for input */
            color: #ffffff; /* Corrected: White text for input */
        }

        .chat-input button {
            background-color: #007bff; /* Send button color */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chat-input button:hover {
            background-color: #0056b3;
        }

        /* Emoji Picker */
        .emoji-picker {
            display: none; /* Hidden by default */
            position: absolute;
            bottom: 60px; /* Above the input field */
            left: 10px;
            background-color: #333;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap;
            max-width: 250px;
            z-index: 10; /* Ensure it's above other chat elements, but still within chatbox context */
        }

        .emoji-button {
            background: none;
            border: none;
            font-size: 1.5em;
            padding: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 3px;
        }

        .emoji-button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div class="chat-header">
            <h3>Community Chat</h3>
            <span class="close-chat" onclick="toggleChat()">X</span>
        </div>
        <div id="messages">
            </div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button id="emoji-button"><i class="far fa-smile"></i></button>
            <div class="emoji-picker"></div>
            <button id="send-button">Send</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        // Firebase configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            databaseURL: "YOUR_DATABASE_URL" // IMPORTANT: Add your Realtime Database URL here
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const messagesRef = ref(database, 'messages');

        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPickerContainer = document.querySelector('.emoji-picker');
        const closeChatButton = document.querySelector('.close-chat'); // Get the close button

        let currentUser = null; // To store current user's display name

        // Function to toggle chat visibility (for the close button)
        window.toggleChat = function() {
            // This function is likely called by the parent index.html to hide/show the iframe
            // Here, we can just ensure the body is ready to be hidden/shown by the parent
            console.log('Toggle chat function called within iframe');
        };

        // Listen for auth state changes to get current user's name
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user.displayName || user.email.split('@')[0]; // Use display name or part of email
            } else {
                currentUser = "Guest";
            }
        });

        // Add event listener for sending messages
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText !== "") {
                const newMessage = {
                    text: messageText,
                    user: currentUser,
                    timestamp: serverTimestamp() // Use Firebase server timestamp
                };
                push(messagesRef, newMessage);
                messageInput.value = ""; // Clear input
                emojiPickerContainer.style.display = 'none'; // Close emoji picker after sending
            }
        }

        // Listen for new messages
        onValue(messagesRef, (snapshot) => {
            messagesDiv.innerHTML = ''; // Clear current messages
            snapshot.forEach((childSnapshot) => {
                const message = childSnapshot.val();
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');

                // Check if message.user is null or undefined and handle it
                const userName = message.user ? message.user : "Anonymous"; // Fallback to "Anonymous"

                // Determine if it's a sent message (assuming current user is logged in)
                const isSent = currentUser && userName === currentUser;
                if (isSent) {
                    messageElement.classList.add('sent');
                } else {
                    messageElement.classList.add('received');
                }

                const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleString() : 'Just now'; // Convert timestamp

                messageElement.innerHTML = `<strong>${userName}:</strong> <span>${message.text}</span><div class="timestamp">${timestamp}</div>`;
                messagesDiv.appendChild(messageElement);
            });
            // Scroll to the bottom to show the latest message
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, (error) => {
            console.error("Error fetching messages: ", error);
        });

        const commonEmojis = [
            'ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š',
            'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜Ÿ', 'ðŸ˜•', 'ðŸ™', 'â˜¹ï¸', 'ðŸ˜£',
            'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ¥º', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ’€', 'ðŸ‘»', 'ðŸ‘½', 'ðŸ¤–', 'ðŸ’©', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼',
            'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾', 'ðŸ‘‹', 'ðŸ¤š', 'ðŸ–ï¸', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ–•', 'ðŸ‘‡', 'â˜ï¸',
            'ðŸ‘', 'ðŸ‘Ž', 'âœŠ', 'ðŸ‘Š', 'ðŸ¤›', 'ðŸ¤œ', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ‘', 'ðŸ¤²', 'ðŸ™', 'âœï¸', 'ðŸ’…', 'ðŸ¤³', 'ðŸ’ª', 'ðŸ¦µ', 'ðŸ¦¶', 'ðŸ‘‚', 'ðŸ‘ƒ', 'ðŸ§ ',
            'ðŸ¦·', 'ðŸ¦´', 'ðŸ‘€', 'ðŸ‘ï¸', 'ðŸ‘…', 'ðŸ‘„', 'ðŸ‘¶', 'ðŸ‘¦', 'ðŸ‘§', 'ðŸ‘¨', 'ðŸ‘©', 'ðŸ§‘', 'ðŸ‘±â€â™€ï¸', 'ðŸ‘±â€â™‚ï¸', 'ðŸ‘´', 'ðŸ‘µ', 'ðŸ§“', 'ðŸ™â€â™€ï¸', 'ðŸ™â€â™‚ï¸', 'ðŸ™Žâ€â™€ï¸', 'ðŸ™Žâ€â™‚ï¸',
            'ðŸ™…â€â™€ï¸', 'ðŸ™…â€â™‚ï¸', 'ðŸ™†â€â™€ï¸', 'ðŸ™†â€â™‚ï¸', 'ðŸ¤·â€â™€ï¸', 'ðŸ¤·â€â™‚ï¸', 'ðŸ—£ï¸', 'ðŸ‘¤', 'ðŸ‘¥', 'ðŸ«‚', 'ðŸ‘ª', 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§', 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦', 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦', 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§', 'ðŸ‘¨â€ðŸ‘¦', 'ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦', 'ðŸ‘¨â€ðŸ‘§', 'ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦', 'ðŸ‘¨â€ðŸ‘§â€ðŸ‘§',
            'ðŸ‘©â€ðŸ‘¦', 'ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦', 'ðŸ‘©â€ðŸ‘§', 'ðŸ‘©â€ðŸ‘§â€ðŸ‘¦', 'ðŸ‘©â€ðŸ‘§â€ðŸ‘§', 'ðŸ’”', 'â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ¤Ž', 'ðŸ–¤', 'ðŸ¤', 'ðŸ’¯', 'ðŸ’¢', 'ðŸ’¥', 'ðŸ’«', 'ðŸ’¦', 'ðŸ’¨', '
        ```

8.  **SAVE THE `chatbox.html` FILE IN VISUAL STUDIO CODE.**
    * Press `Ctrl + S` (Windows) / `Cmd + S` (Mac).
    * **CRITICAL VERIFICATION:** Ensure the small white circle on the `chatbox.html` tab in VS Code **disappears**, and the tab shows an 'x'. This is your confirmation that the file has been saved correctly.

---

**After you have confirmed that `chatbox.html` is SAVED in VS Code with this completely new content, then push your changes:**

1.  **Open your PowerShell window** (in your `K:\FLM-PLATFORM>` directory).
2.  **Stage your changes:**
    ```bash
    git add .
    ```
3.  **Commit your changes:**
    ```bash
    git commit -m "Refactor: Overhauled chatbox.html for consistent styling and functionality"
    ```
4.  **Push your changes to GitHub:**
    ```bash
    git push -u origin main
    ```
    (Use your Personal Access Token if prompted for a password.)

After the `git push` command finishes successfully, give Netlify a minute or two to deploy. Then, do a **hard refresh** of your live site. This should absolutely resolve the "white space" and make your chat box fully functional and visually correct! Let me know how it looks!